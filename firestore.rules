rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // HELPERS & VALIDATORS
    // ========================================================================

    // Authentication & Authorization
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Role-based Access Control
    // Checks if the user is a hardcoded SuperAdmin (Security Bootstrap)
    function isSuperAdmin() {
      return isSignedIn() && (
        (request.auth.token.email == 'dreamings.desings.3d@gmail.com' && request.auth.uid == 'uJ9780LRm5f27mFOSuxbgKuwSIC3') ||
        (request.auth.token.email == 'danielanthonychaina@gmail.com' && request.auth.uid == 'MoklmYcQa1h47mQqo7deCT9qdqp1')
      );
    }

    // Reads the user's document to check for 'admin' role OR allows hardcoded SuperAdmins.
    function isAdmin() {
      return isSuperAdmin() || (
        isSignedIn() && (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        )
      );
    }

    // Data Validation Helpers
    function isValidString(data, field, minLen, maxLen) {
      return data.keys().hasAll([field]) 
          && data[field] is string 
          && data[field].size() >= minLen 
          && data[field].size() <= maxLen;
    }

    function isValidNumber(data, field, min, max) {
      return data.keys().hasAll([field]) 
          && data[field] is number 
          && data[field] >= min 
          && data[field] <= max;
    }

    // Check if field is NOT modified in an update
    function notUpdating(field) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny([field]);
    }

    // Common timestamp validation (createdAt should not change)
    function isValidTimestamp(data, field) {
      return data.keys().hasAll([field]) && data[field] is timestamp;
    }

    // ========================================================================
    // 1. USERS (Usuarios)
    // ========================================================================
    match /users/{userId} {
      // Read: Owner or Admin
      allow read: if isOwner(userId) || isAdmin();
      
      // Create: Owner only (Registration)
      allow create: if isOwner(userId) 
                    && (
                      (!request.resource.data.keys().hasAny(['role']) || request.resource.data.role == 'user')
                      || 
                      (request.resource.data.role == 'admin' && isSuperAdmin())
                    )
                    && request.resource.data.keys().hasOnly(['name', 'email', 'username', 'photoURL', 'phone', 'address', 'birthDate', 'createdAt', 'updatedAt', 'role', 'lastLogin', 'favorites', 'addresses', 'isActive'])
                    && isValidTimestamp(request.resource.data, 'createdAt');

      // Update: Owner (can edit profile but NOT role or stats) or Admin (can edit everything)
      allow update: if (isOwner(userId) 
                        && (
                          // Standard User Update
                          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'username', 'photoURL', 'phone', 'address', 'birthDate', 'updatedAt', 'lastLogin', 'favorites', 'addresses', 'status'])
                           && notUpdating('role') 
                           && notUpdating('createdAt')
                           && notUpdating('totalOrders') 
                           && notUpdating('totalSpent'))
                          ||
                          // SuperAdmin Bootstrap/Recovery (Self-promotion)
                          (request.resource.data.role == 'admin' && isSuperAdmin())
                        ))
                    || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ========================================================================
    // 2. PRODUCTS (Productos - Catalog)
    // ========================================================================
    match /products/{productId} {
      allow read: if true;
      
      // Admin only for writes
      allow create: if isAdmin()
                    && isValidString(request.resource.data, 'name', 3, 100)
                    && isValidNumber(request.resource.data, 'price', 0, 100000);
                    
      allow update: if isAdmin()
                    && isValidString(request.resource.data, 'name', 3, 100)
                    && isValidNumber(request.resource.data, 'price', 0, 100000);
                    
      allow delete: if isAdmin();
    }

    // ========================================================================
    // 3. SERVICES (Servicios)
    // ========================================================================
    match /services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ========================================================================
    // 4. PROJECTS (Portafolio)
    // ========================================================================
    match /projects/{projectId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ========================================================================
    // 5. CATEGORIES
    // ========================================================================
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ========================================================================
    // 6. ORDERS (Pedidos)
    // ========================================================================
    match /orders/{orderId} {
      // Read: Owner or Admin
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      
      // Create: Authenticated users.
      allow create: if isSignedIn() 
                    && request.resource.data.userId == request.auth.uid
                    && isValidNumber(request.resource.data, 'total', 0, 1000000)
                    && isValidTimestamp(request.resource.data, 'createdAt')
                    && (request.resource.data.status == 'pending_payment' || request.resource.data.status == 'quote_requested');
      
      // Update: Admin or Owner (cancellation only)
      allow update: if isAdmin() 
                    || (isOwner(resource.data.userId) 
                        && (resource.data.status == 'pending_payment' || resource.data.status == 'quote_requested')
                        && request.resource.data.status == 'cancelled'
                        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']));
                        
      allow delete: if isAdmin();
    }

    // ========================================================================
    // 7. REVIEWS (Reseñas)
    // ========================================================================
    match /reviews/{reviewId} {
      allow read: if true;
      
      allow create: if isSignedIn() 
                    && request.resource.data.userId == request.auth.uid
                    && isValidNumber(request.resource.data, 'rating', 1, 5)
                    && isValidString(request.resource.data, 'comment', 1, 2000);
                    
      allow update: if (isOwner(resource.data.userId) && notUpdating('productId') && notUpdating('userId')) 
                    || isAdmin();
                    
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // ========================================================================
    // 8. WISHLIST
    // ========================================================================
    match /wishlist/{itemId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isOwner(resource.data.userId);
    }

    // ========================================================================
    // 9. NOTIFICATIONS
    // ========================================================================
    match /notifications/{notifId} {
      allow read: if (resource.data.userId == request.auth.uid) || (resource.data.userId == null && isAdmin());
      allow write: if isAdmin(); 
    }

    // ========================================================================
    // 10. CONTACTS (Formulario de contacto)
    // ========================================================================
    match /contacts/{contactId} {
      allow create: if true 
                    && request.resource.data.keys().hasOnly(['email', 'message', 'name', 'subject', 'phone', 'createdAt', 'read'])
                    && isValidString(request.resource.data, 'email', 3, 200)
                    && isValidString(request.resource.data, 'message', 1, 5000);
      allow read, update, delete: if isAdmin();
    }

    // ========================================================================
    // 11. LANDINGS & CONFIGURATION
    // ========================================================================
    
    // Service Landings (NUEVO)
    match /service_landings/{landing} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Landing Principal
    match /landing_main/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Campañas Estacionales
    match /seasonal_themes/{themeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // SEO
    match /seo_routes/{pathId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Finances
    match /finances/{record} {
      allow read, write: if isAdmin();
    }

    // ========================================================================
    // 12. GLOBAL ADMIN CATCH-ALL (Evita errores de permisos futuros)
    // ========================================================================
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
